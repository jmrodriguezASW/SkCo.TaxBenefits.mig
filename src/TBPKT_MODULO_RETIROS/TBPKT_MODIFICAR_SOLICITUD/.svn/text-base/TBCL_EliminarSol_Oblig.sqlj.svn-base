package TBPKT_MODULO_RETIROS.TBPKT_MODIFICAR_SOLICITUD;

import java.sql.*;

import oracle.sqlj.runtime.*;

import sqlj.runtime.*;
import sqlj.runtime.ref.*;
import TBPKT_UTILIDADES.TBPKT_PLANTILLA.*;
import TBPKT_UTILIDADES.TBPKT_CONEXIONBASEDATOS.*;
import java.text.NumberFormat;
import javax.servlet.http.*;
import java.io.*;

public class TBCL_EliminarSol_Oblig extends HttpServlet{
    
    #sql iterator i_retiro (java.sql.Date RET_FECHA_EFECTIVA, int RET_CONSECUTIVO, double RET_VALOR, String CON_NOMBRES, String CON_APELLIDOS);
    /**Variable tipo iterator v_retiro*/
    i_retiro v_retiro;

    
public void TBPL_EliminarSol_Oblig(PrintWriter out,HttpSession session,HttpServletRequest request,String nuevaCadena )
 {
  STBCL_GenerarBaseHTML i_pagina  = new STBCL_GenerarBaseHTML ();/**Instancia de la clase TBCL_GenerarBaseHTML*/
  TBCL_Validacion        i_valusu = new TBCL_Validacion();/**Instancia de la clase TBCL_GenerarBaseHTML*/  
  try
  {
   String[] v_valusu = new String[3];
   v_valusu=i_valusu.TBFL_ValidarUsuario();
   DriverManager.registerDriver(new oracle.jdbc.driver.OracleDriver());
   DefaultContext ctx7 = new DefaultContext(v_valusu[0],v_valusu[1],v_valusu[2],false);
   DefaultContext.setDefaultContext(ctx7);   
    
   /**Definicion de variables*/
   /**Tipo String*/
   String v_contra     = "";/**Variable número del contrato*/
   String v_pro        = "";/**Variable código del producto*/
   String v_pie        = "";/**Variable dibujar inicio página*/
   String v_pintar     = "";/**Variable dibujar final página*/
   String v_nombre     = "";/**Variable nombre afiliado*/
   String v_apellidos  = "";/**Variable apellido afiliado*/
   boolean v_encontro  = false;/**Verificar que se encontraron datos*/
   boolean v_check     = false;/**Verificar que el primer dato quede chequeado*/
   String s_ruta_serv  = "";

   /**Verificar que las variables de session no expiren*/
   if((java.lang.String)session.getValue("s_contrato")!= null ||(java.lang.String)session.getValue("s_producto")!= null)
   {
    /**Capturar variables de session*/    
    v_contra     = (java.lang.String)session.getValue("s_contrato");//contrato
    v_pro        = (java.lang.String)session.getValue("s_producto");//producto 
    
    //Obtener direccion servidor TAX  
    #sql {select ref_descripcion into :s_ruta_serv from tbreferencias WHERE REF_CODIGO='DSR001'};  
    session.removeValue("s_ruta_serv");
    session.putValue("s_ruta_serv",(java.lang.Object)s_ruta_serv); 
    
    #sql v_retiro = {   SELECT  ret_fecha_efectiva, 
                                RET_CONSECUTIVO, 
                                RET_VALOR, 
                                CON_NOMBRES, 
                                CON_APELLIDOS 
                        FROM TBRETIROS                        
                        INNER JOIN TBCONTRATOS ON CON_PRO_CODIGO = RET_CON_PRO_CODIGO AND CON_NUMERO = RET_CON_NUMERO
                        WHERE   RET_CON_PRO_CODIGO = :v_pro 
                                AND RET_CON_NUMERO = :v_contra 
                                AND RET_REF_ESTADO = 'SER001'
                      };

    /**Dibujar página de respuesta*/
    v_pintar=    i_pagina.TBFL_CABEZA("Modificar Solicitud de Retiro","Modificar Solicitud de Retiro","TBPKT_MODULO_RETIROS.TBPKT_MODIFICAR_SOLICITUD.TBS_FinalizarEliminar_Oblig","",true,"","");
    out.println(""+v_pintar+"");
    while(v_retiro.next())
    {
        if(!v_encontro)
        {
          v_nombre= v_retiro.CON_NOMBRES().trim();
          session.removeValue("s_nombres");
          session.putValue("s_nombres",(java.lang.Object)v_nombre);
          v_apellidos = v_retiro.CON_APELLIDOS().trim();
          session.removeValue("s_apellidos");
          session.putValue("s_apellidos",(java.lang.Object)v_apellidos);      
          String v_contrato_unif = "";
          #sql v_contrato_unif = {values(TBFBD_obtener_ref_unica(:v_pro,:v_contra))};
          out.println("<FONT color=#000000 face='Verdana, Arial, Helvetica, sans-serif' size=1><CENTER><b>Producto</b> "+v_pro+"    <b>Contrato</b>"+v_contrato_unif+" </center></font>");
          out.println("<FONT color=#000000 face='Verdana, Arial, Helvetica, sans-serif' size=1><CENTER><b>Nombres</b>  "+v_nombre+"  <b> Apellidos </b>"+v_apellidos+" </CENTER></font>");
          out.println("<br>");
          out.println("<center><table width='100%' border='1' border-color='#aaaaaa' cellspacing='0' cellpadding='0'>");
          out.println("<tr><td class=\"td11\" colspan= 7 ><center><font face='Verdana, Arial, Helvetica, sans-serif' size='1'><font color='#FFFFFF' ><b>Solicitudes de Retiros</b></font></center></font></td></tr>");
          out.println("<tr><td class=\"td11\" ><center><font face='Verdana, Arial, Helvetica, sans-serif' size='1' color='#FFFFFF'><b>Fecha Efectiva</b></center></font></td>");
          out.println("<td class=\"td11\" ><center><font face='Verdana, Arial, Helvetica, sans-serif' size='1' color='#FFFFFF'><b>Valor del Retiro</b></center></font></td></TR>");    
        }
        
     /**Chequear el primer registro por default*/
     if(v_check == false)
     {

      out.println("<tr><td ><font face='Verdana, Arial, Helvetica, sans-serif' size='1' color='#000000'><input type =radio name=v_conret value= "+v_retiro.RET_CONSECUTIVO()+"  checked>"+v_retiro.RET_FECHA_EFECTIVA()+"</font></td>");
      out.println("<td align=right><font face='Verdana, Arial, Helvetica, sans-serif' size='1' color='#000000'> "+NumberFormat.getCurrencyInstance().format(v_retiro.RET_VALOR())+"</font></td></tr>");
      v_check = true;      
      v_encontro = true;
     }
     else
     {
      out.println("<tr><td ><font face='Verdana, Arial, Helvetica, sans-serif' size='1' color='#000000'><input type =radio name=v_conret value= "+v_retiro.RET_CONSECUTIVO()+"  >"+v_retiro.RET_FECHA_EFECTIVA()+"</font></td>");
      out.println("<td align=right ><font face='Verdana, Arial, Helvetica, sans-serif' size='1' color='#000000'> "+NumberFormat.getCurrencyInstance().format(v_retiro.RET_VALOR())+"</font></td></tr>");
      v_encontro =true;
     }  
        
    }
    v_retiro.close();
    
    /**Cuando no se encuentran datos*/
    if(v_encontro == false)
    {
     out.println("<center><table width='100%' border='1' cellspacing='0' cellpadding='0'>");
     out.println("<tr><td class=\"td11\" colspan= 7 ><center><font face='Verdana, Arial, Helvetica, sans-serif' size='1'><font color='#FFFFFF' ><b>Solicitudes de Retiros</b></font></center></font></td></tr>");
     out.println("<tr><td class=\"td11\" ><center><font face='Verdana, Arial, Helvetica, sans-serif' size='1' color='#FFFFFF'><b>Fecha Efectiva</b></center></font></td>");
     out.println("<td class=\"td11\" ><center><font face='Verdana, Arial, Helvetica, sans-serif' size='1' color='#FFFFFF'><b>Valor del Retiro</b></center></font></td></TR>");
     out.println("<tr><td  ><center><font face='Verdana, Arial, Helvetica, sans-serif' size='1' color='#000000'>--</font></center></td>");
     out.println("<td><center><font face='Verdana, Arial, Helvetica, sans-serif' size='1' color='#000000'>--</font></td></center></tr>");
     out.println("<tr><td colspan= 5><center><font face='Verdana, Arial, Helvetica, sans-serif' size='1' color='#000000'>No se encontraron Solicitudes de retiro para modificar</font></center></td><tr>");
     out.println("</table></center>");
     out.println("<br>");
     out.println("<center><input type=button value='Aceptar' onclick=' history.go(-1)'><input type=button value='Regresar' onclick=' history.go(-1)'></center>");
     v_pie = i_pagina.TBFL_PIE;
     out.println("<br>");
     out.println(""+v_pie+"");
     out.close();
    }
    out.println("</table></center>");
    out.println("<pre><FONT color=#000000 face='Verdana, Arial, Helvetica, sans-serif' size=2><input type=radio NAME=v_modificar VALUE='0' checked>  Eliminar Solicitud de Retiro Pendiente de enviar </font></pre>");
    out.println("<br>");
    out.println("<PRE>");
    out.println("<INPUT ID=cadena NAME=cadena TYPE=hidden VALUE='"+nuevaCadena+"'>");
    out.println("<center><input type=submit value='Aceptar'><input type=button value='Regresar' onclick=' history.go(-1)'></center>");
    v_pie = i_pagina.TBFL_PIE;
    out.println("<br>");
    out.println(""+v_pie+"");
    out.close();
   }
   else
   {/**Termino session*/
    v_pintar=    i_pagina.TBFL_CABEZA("Modificar Solicitud de Retiro","Error al Modificar  Solicitud de Retiro","","<center>Error de comunicación no se tiene conexión con el servidor web,por favor intente de nuevo.</center>",false);
    out.println(""+v_pintar+"");
    v_pie = i_pagina.TBFL_PIE;
    out.println("<br>");
    out.println("<center><input type=button value='Aceptar'  onclick=' history.go(-2)'></center>");
    out.println(""+v_pie+"");
    out.close();
   }
  /**Terminar session base de datos*/  
  ctx7.getConnection().close();
  }
  catch(Exception ex)
  {/**manejo de errores*/
   String v_menex = "";
      String error = ex.toString();
   if(ex.equals("java.sql.SQLException: found null connection context"))
   {
    v_menex = "Error de comunicación no se tiene conexión con el servidor web,por favor intente de nuevo.";
   }
   else if(error.trim().equals("java.sql.SQLException: Io exception: End of TNS data channel") ||  error.trim().equals("java.sql.SQLException: ORA-01034: ORACLE not available"))
      {
        v_menex = "No se tiene comunicación con el servidor de datos  por favor ingrese nuevamente.";
      }
      else if (error.trim().equals("java.sql.SQLException: Io exception: Connection reset by peer: socket write error"))
           {
             v_menex = "Se reinicio la base de datos por favor ingrese nuevamente.";
           }
           else if(error.trim().equalsIgnoreCase("java.sql.SQLException: Closed Connection"))
                {
                 v_menex = "Error momentaneo de comunicación con el servidor de datos, por favor intente entrar de nuevo a la opción.";
                }
                else if(error.trim().equalsIgnoreCase("java.sql.SQLException:IOEXCEPTION:DESCRIPTOR NOT A SOCKET:SOCKET WRITE ERROR"))
                     {
                       v_menex =  "Error momentaneo de comunicación con el servidor Web, por favor intente entrar de nuevo a la opción.";
                     }

                     else
                     {
                       v_menex = "Mensaje de error: "+ex;
                     }
   String v_pintar=    i_pagina.TBFL_CABEZA ("Modificar Solicitud de Retiro","Error al Modificar Solicitud de Retiro","","<center>"+v_menex+"</center>",false);
   out.println(""+v_pintar+"");
   out.println("<BR>");
   out.println("<center><input type=button value='Aceptar'  onclick=' history.go(-2)'><input type=button value='Regresar' onclick=' history.go(-1)'></center>");
   String v_pie = i_pagina.TBFL_PIE;
   out.println("<br>");
   out.println("<br>");
   out.println(""+v_pie+"");
   out.close();
  }
 }    
}
