package TBPKT_MODULO_RETIROS.TBPKT_MODIFICAR_SOLICITUD;

import sqlj.runtime.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.http.*;
import java.io.*;
import sqlj.runtime.ref.DefaultContext ;
import TBPKT_UTILIDADES.TBPKT_PLANTILLA.*;
import TBPKT_UTILIDADES.TBPKT_CONEXIONBASEDATOS.*;


/**Clase que hace llamado la función almacenada TB_FACTUALIZAR_ESTADO, que se encarga de borra@
* la relación aportes_retiros, cargos y devuelve los saldos a los aportes afectados. */
public class TBCL_EliminarTax extends HttpServlet
{
 /**Itrator de valor de unidad del retiro*/
 #sql iterator i_valor (double RET_VALOR_UNIDAD);
 /**Variable tipo iterator i_valor*/
 i_valor v_valor;
 /**Procedimineto local que relimina solicitud de retiro antes de ser procesado en la interfaz nocturna.*/
 public void TBPL_EliminarTax(PrintWriter out,HttpSession session,HttpServletRequest request)
 {
  /**Instancias de clase*/
  STBCL_GenerarBaseHTML i_pagina  = new STBCL_GenerarBaseHTML ();/**Instancia de la clase TBCL_GenerarBaseHTML*/
  //TBCL_ConexionSqlj    i_conexion = new TBCL_ConexionSqlj();/**Instancia de la clase TBCL_ConexionSqlj*/
  TBCL_Validacion  i_valusu = new     TBCL_Validacion ();

  try
  {
   String[] v_valusu = new String[3];
   v_valusu=i_valusu.TBFL_ValidarUsuario();
   DriverManager.registerDriver(new oracle.jdbc.driver.OracleDriver());
   DefaultContext ctx5 = new DefaultContext(v_valusu[0],v_valusu[1],v_valusu[2],false);
   DefaultContext.setDefaultContext(ctx5);
   /**Realizar conexión a la base de datos*/
   //i_conexion.TBCL_ConexionBaseDatos();

   /**Definicion de variables*/
   /**Tipo boolean*/
   boolean v_encontro   = false;
   /**Tipo double*/
   double v_valuni      = 0;
   /**Tipo String*/
   String v_mensaje     = "";
   String v_contra      = "";
   String v_pro         = "";
   String v_consecutivo = "";
   String v_usuario     = "";
   String v_pintar      = "";
   String v_pie         = "";
   /**Tipo int*/
   int v_consecutivo2   = 0;
   int indicador        = 0;
         
   /**Verificar que las variables de session no expiren*/
   if((java.lang.String)session.getValue("s_contrato")!= null ||(java.lang.String)session.getValue("s_producto") != null)
   {
    /**Capturar variables de session*/
    v_contra =(java.lang.String)session.getValue("s_contrato");/**Tomar contrato*/
    v_pro = (java.lang.String)session.getValue("s_producto");/**Tomar producto*/
    v_consecutivo = (java.lang.String)session.getValue("s_conret");/**Tomar consecutivo del retiro a eliminar*/
    v_usuario  = (java.lang.String)session.getValue("s_usuariopipe");/**Tomar nombre de usuario*/
    v_consecutivo2 = new Integer(v_consecutivo).intValue();/**Consecutivo numerico*/

    /**Consultar valor de unidad del retiro*/
    #sql v_valor = {SELECT RET_VALOR_UNIDAD
                      FROM tbretiros
                     WHERE RET_CON_PRO_CODIGO = :v_pro
                       AND RET_CON_NUMERO     = :v_contra
                       AND RET_CONSECUTIVO    = :v_consecutivo2

                    };

    /**Mientras se encuentren datos*/
    while (v_valor.next())
    {
     v_valuni = v_valor.RET_VALOR_UNIDAD();
     v_encontro = true;
    }
    v_valor.close();

    if (v_encontro)
    {//1
     /**Llamar función que reversa, elimina relacion aportexretiro y actualiza estado*/
     #sql  indicador = {values (TB_FACTUALIZAR_ESTADO(:v_pro, :v_contra,:v_consecutivo2,:v_valuni,'SER002' ,'Se elimino la Solicitud de Retiro antes de ser enviada a Multifund',:v_usuario,:OUT v_mensaje))};
     /**Si no hubo error*/
     if (indicador == 0)
     {//1
      #sql {COMMIT};
      /**Dibujar página de respuesta*/
      v_pintar=    i_pagina.TBFL_CABEZA("Eliminar Solicitud de Retiro","Eliminar Solicitud de Retiro","","<center>"+v_mensaje+"</center>",false);
      out.println(""+v_pintar+"");
      v_pie = i_pagina.TBFL_PIE;
      out.println("<br>");
      out.println("<center><input type=button value='Aceptar'  onclick=' history.go(-2)'><input type=button value='Regresar' onclick=' history.go(-1)'></center>");
      out.println(""+v_pie+"");
      out.close();
     }
     else
     {/**Si hubo error*/
      #sql {ROLLBACK};
      v_pintar=    i_pagina.TBFL_CABEZA("Eliminar Solicitud de Retiro","Error al Eliminar Solicitud de Retiro","","<center>"+v_mensaje+"</center>",false);
      out.println(""+v_pintar+"");
      v_pie = i_pagina.TBFL_PIE;
      out.println("<br>");
      out.println("<center><input type=button value='Cancelar'  onclick=' history.go(-2)'><input type=button value='Regresar' onclick=' history.go(-1)'></center>");
      out.println(""+v_pie+"");
      out.close();
     }
    }
    else
    {/**No se encontraron datos para el número del retiro*/
     #sql {ROLLBACK};
     v_pintar=    i_pagina.TBFL_CABEZA("Eliminar Solicitud de Retiro","Error al Eliminar Solicitud de Retiro","","<center>Solicitud de Retiro número "+v_consecutivo+" no se encontro en el sistema.</center>",false);
     out.println(""+v_pintar+"");
     v_pie = i_pagina.TBFL_PIE;
     out.println("<br>");
     out.println("<center><input type=button value='Cancelar'  onclick=' history.go(-2)'><input type=button value='Regresar' onclick=' history.go(-1)'></center>");
     out.println(""+v_pie+"");
     out.close();
    }
   }
   else
   {/**Se termino session*/
    v_pintar=    i_pagina.TBFL_CABEZA("Eliminar Solicitud de Retiro","Error al Eliminar Solicitud de Retiro","","<center>Error de comunicación no se tiene conexión con el servidor web,por favor intente de nuevo.</center>",false);
    out.println(""+v_pintar+"");
    v_pie = i_pagina.TBFL_PIE;
    out.println("<br>");
    out.println("<center><input type=button value='Cancelar'  onclick=' history.go(-2)'></center>");
    out.println(""+v_pie+"");
    out.close();
   }
   /**Desconectar base de datos*/
   //i_conexion.TBCL_DesconectarBaseDatos();
   ctx5.getConnection().close();
  }
  catch(Exception ex)
  {/**Mnejo de error*/
   String v_menex = "";
   String error = ex.toString();
   if(ex.equals("java.sql.SQLException: found null connection context"))
   {
    v_menex = "Error de comunicación no se tiene conexión con el servidor web,por favor intente de nuevo.";
   }
   else if(error.trim().equals("java.sql.SQLException: Io exception: End of TNS data channel") ||  error.trim().equals("java.sql.SQLException: ORA-01034: ORACLE not available"))
      {
        v_menex = "No se tiene comunicación con el servidor de datos  por favor ingrese nuevamente.";
      }
      else if (error.trim().equals("java.sql.SQLException: Io exception: Connection reset by peer: socket write error"))
           {
             v_menex = "Se reinicio la base de datos por favor ingrese nuevamente.";
           }
           else if(error.trim().equalsIgnoreCase("java.sql.SQLException: Closed Connection"))
                {
                 v_menex = "Error momentaneo de comunicación con el servidor de datos, por favor intente entrar de nuevo a la opción.";
                }
                else if(error.trim().equalsIgnoreCase("java.sql.SQLException:IOEXCEPTION:DESCRIPTOR NOT A SOCKET:SOCKET WRITE ERROR"))
                     {
                       v_menex =  "Error momentaneo de comunicación con el servidor Web, por favor intente entrar de nuevo a la opción.";
                     }

                     else
                     {
                       v_menex = "Mensaje de error: "+ex;
                     }
   String v_pintar=    i_pagina.TBFL_CABEZA ("Eliminar Solicitud de Retiro","Error al Eliminar Solicitud de retiro","","<center>"+v_menex+"</center>",false);
   out.println(""+v_pintar+"");
   out.println("<BR>");
   out.println("<center><input type=button value='Aceptar'  onclick=' history.go(-2)'><input type=button value='Regresar' onclick=' history.go(-1)'></center>");
   String v_pie = i_pagina.TBFL_PIE;
   out.println("<br>");
   out.println("<br>");
   out.println(""+v_pie+"");
   out.close();
  }
 }
}

